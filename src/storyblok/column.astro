---
import { renderRichText } from "@storyblok/astro";
import { ColumnStoryblok } from "@types";

import { CTAButton } from "storyblok/atoms/CTAButton";
import { resolveColumnStylesBlocks } from "storyblok/styles/resolveStyles";

const { blok } = Astro.props;

type Props = {
  blok: ColumnStoryblok;
};

const extractImgTag = (htmlString: string): string => {
  const regex = /<([^>]+)>(\s*<img[^>]*>\s*)(.*?)<\/\1>/g;
  return htmlString.replace(regex, "$2<$1>$3</$1>");
};

const removeEmptyTags = (htmlString: string): string => {
  const regex = /<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g;
  return htmlString.replace(regex, "");
};

const renderedRichText = removeEmptyTags(
  extractImgTag(
    renderRichText(blok.content, {
      resolver: (component, blok) => {
        switch (component) {
          case "ctaButton":
            return CTAButton(blok);
          default:
            return null;
        }
      },
    })
  )
);

const { classNames } = resolveColumnStylesBlocks(blok?.styles);
---

<style>
  .column {
    /* aspect-ratio: 9 / 16; */

    :global(img) {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    &.escapeContainer {
      grid-column: span 2;

      &:first-child {
        grid-column: 1 / span 2;
      }
    }

    @media (min-width: 768px) {
      &.tablet-escapeContainer {
        grid-column: span 2;

        &:first-child {
          grid-column: 1 / span 2;
        }
      }
    }

    @media (min-width: 1024px) {
      &.desktop-escapeContainer {
        grid-column: span 2;

        &:first-child {
          grid-column: 1 / span 2;
        }
      }
    }
  }
</style>

<!-- Column -->
<div class:list={["column", classNames]} set:html={renderedRichText} />
<!--  -->
